@model IEnumerable<SOPACE_MVC.Models.klaim_medis>

@{
    ViewBag.Title = "ViewClaimMedical";
    Layout = "~/Views/MasterLayout/MasterAdmin.cshtml";
}
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12" style="margin-top:20px">
            <h1 class="page-header">List Claim Medical</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <ul class="nav nav-pills" id="navpill_">
                        <li class="active" id="Requested">
                            <a href="#home-pills" data-toggle="tab">Requested</a>
                        </li>
                        <li id="Processed">
                            <a href="#profile-pills" data-toggle="tab">Processed</a>
                        </li>
                        <li id="Finished">
                            <a href="#messages-pills" data-toggle="tab">Finished</a>
                        </li>
                        <li id="Rejected">
                            <a href="#messages-pills" data-toggle="tab">Rejected</a>
                        </li>
                    </ul>
                </div>

                <div class="panel-body">
                    <table class="table table-striped table-bordered table-hover tbl_viewClaim">
                        <thead>
                            <tr>
                                <th style="text-align:center" scope="col" width="230px" height=25px>NIP</th>
                                <th style="text-align:center" scope="col" width="150px" height=25px>Tipe Klaim</th>
                                <th style="text-align:center" scope="col" width="150px" height=25px>Tanggal</th>
                                <th style="text-align:center" scope="col" width="150px" height=25px>Total Biaya</th>
                                <th style="text-align:center" scope="col" width="150px" height=25px>Status</th>
                                <th id="action" style="text-align:center" scope="col" width="280px" height=25px>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--MODAL VIEW-->
    <div class="modal" tabindex="-1" role="dialog" id="mymodal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background-color:dodgerblue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3 class="modal-title"><i class="glyphicon glyphicon-eye-open"></i> View Detail Claim</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <span>NIP</span>
                                <input disabled id="nip" placeholder="NIP" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Nama Pasien</span>
                                <input disabled id="npasien" placeholder="Nama Pasien" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Alamat Rumah Sakit</span>
                                <textarea id="alamat" disabled class="form-control" placeholder="Alamat Rumah Sakit"></textarea>
                            </div>
                            <div class="form-group">
                                <span>No. Telp</span>
                                <input disabled id="notlp" placeholder="Nomor Telepon" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Status</span>
                                <input disabled id="status" placeholder="Status Proses" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Klaim yang Dibayarkan</span>
                                <input disabled id="payout" placeholder="Klaim yang dibayarkan" class="form-control" />
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <span>Tipe Claim</span>
                                <input disabled id="tipe" placeholder="Tipe Claim" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Hubungan dengan Pasien</span>
                                <input disabled id="hbgn" placeholder="Hubungan dengan Pasien" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Alasan</span>
                                <textarea id="alasan_reject" disabled class="form-control" placeholder="Alasan"></textarea>
                            </div>
                            <div class="form-group">
                                <span>Tanggal Rawat</span>
                                <input disabled id="tglrwt" placeholder="Tanggal Rawat" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Total Biaya</span>
                                <input disabled id="total" placeholder="Total Biaya" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!--MODAL ALASAN REJECT-->
    <div class="modal" tabindex="-1" role="dialog" id="modalReject">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Alasan Reject</h3>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="reject">
                        <div class="row">
                            <div class="col-lg-12">
                                <label>ID</label>
                                <input readonly name="idklaim_medis" id="idmedis" placeholder="ID" class="form-control" />
                            </div>
                            <div class="col-lg-12">
                                <label>Alasan Reject</label>
                                <textarea name="alasan_reject" required class="form-control col-xs-12" placeholder="Alasan"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="submit_reject" class="btn btn-success" data-dismiss="modal">Submit</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>
@section Script{
    <script>
        var nip="";
        var temp = "Requested";
        $().ready(function () {
            getData(temp);
        });

        $("#navpill_").click("li", function (e) {
            $("#navpill_ li.active").removeClass("active");
            $(this).addClass("active");
            $('.tbl_viewClaim').DataTable().destroy();
            getData(e.target.innerHTML);
            temp = e.target.innerHTML;
        });

        function ViewDetail(idklaim) {
            $.get('@Url.Action("detailClaim","Claim")'
                , { 'idklaim': idklaim }
                , function (model) {
                    let tot = model[0].total_tagihan;
                    //console.log(model);
                    $("#tipe").val(model[0].id_tipe);
                    $("#nip").val(model[0].NIP);
                    $("#npasien").val(model[0].nama_pasien);
                    $("#hbgn").val(model[0].hubungan_pasien);
                    $("#alamat").val(model[0].alamat_rs);
                    $("#notlp").val(model[0].no_tlp);
                    $("#tglrwt").val(model[0].value);
                    $("#status").val(model[0].status);
                    $("#alasan_reject").val(model[0].alasan_reject);
                    $("#total").val('Rp. ' + model[0].total_tagihan);
                    $("#payout").val('Rp. ' + model[0].payout);
            });
        }

        function getData(StatusReq) {
             $.get(
                 '@Url.Action("getDataListClaim","Claim")',
                 { 'status': StatusReq },
                function (data) {
                    $( ".tbl_viewClaim tbody").empty();
                    $.each(data, function (i, model) {
                        nip = model.NIP;
                        var date = `${model.value}`
                        //=========================================================== button Request
                        var btn_delete = `<button onclick="DeleteClaim('${model.id_klaim_medis}')" class='btn btn-danger'>
                                         <i class="glyphicon glyphicon-trash"></i></button>`;
                        var btn_edit = `<a href="/EditClaim/${model.id_klaim_medis}" class='btn btn-primary'>
                                         <i class="glyphicon glyphicon-edit"></i></a>`;
                        var btn_process = `<button id="${model.id_klaim_medis}" name="Processed" class='btn btn-success'>
                                         <i class="glyphicon glyphicon-ok"></i></button>`;
                        var btn_reject = `<button id="${model.id_klaim_medis}" onclick="RejectClaim('${model.id_klaim_medis}')"
                                            class='btn btn-warning'><i class="glyphicon glyphicon-remove"></i></a>`;

                        //============================================================ button Proses
                        var btn_detail = `<a class='btn btn-info' onclick="ViewDetail('${model.id_klaim_medis}')" data-toggle='modal' data-target='#mymodal'>
                                            <i class="glyphicon glyphicon-eye-open"></i></a>`;
                        var btn_accept = `<a id="${model.id_klaim_medis}" onclick="UpdateSaldo('${model.id_klaim_medis}')"
                                            class='btn btn-success'><i class="glyphicon glyphicon-ok"></i></a>`;

                        //============================================================ button Finish

                        //============================================================= untuk memasukkan ke dalam IF ELSE
                        var statusRequested = `<td style=text-align:center height=50px > ${btn_process} ${btn_edit} ${btn_delete} </td >` + `</tr >`;
                        var statusProcessed = `<td style=text-align:center height=50px > ${btn_accept} ${btn_reject} </td >` + `</tr >`;
                        var statusFinished = `<td style=text-align:center height=50px > ${btn_detail} </td >` + `</tr >`;
                        var rows1 = `<td style=text-align:center height=50px > ${model.payout} </td >` + `</tr >`;

                        //============================================================== Membuat row
                        var rows = `<tr>`
                            + `<td style=text-align:center height=50px><a href="#" onclick="ViewDetail('${model.id_klaim_medis}')" data-toggle='modal' data-target='#mymodal'> ${model.NIP}</a></td>`
                            + `<td style=text-align:center height=50px> ${model.id_tipe}</td >`
                            + `<td style=text-align:center height=50px> ${date}</td >`
                            + `<td style=text-align:center height=50px> ${model.total_tagihan}</td >`
                            + `<td style=text-align:center height=50px> ${model.status}</td >`;
                        if (model.status == "Requested") {
                            $(".tbl_viewClaim tbody").append(rows + statusRequested);
                        } else if (model.status == "Processed") {
                            $(".tbl_viewClaim tbody").append(rows + statusProcessed);
                        } else {
                            $(".tbl_viewClaim tbody").append(rows + rows1);
                        }

                    });
                    $('.tbl_viewClaim').DataTable();
                });
            if (StatusReq == "Finished" || StatusReq == "Rejected") {
                $("#action").text("Payout");
            } else {
                $("#action").text("Action");
            }
        }

        $(".tbl_viewClaim tbody").on("click", "button[name='Processed']", function (e) {
            $.get('@Url.Action("updateClaim", "Claim")',
                { 'idClaim': $(this)[0].id, 'status': $(this)[0].name },
                function (data)
                {
                    getData(temp);
                }
            )
        });

        function UpdateSaldo(idklaim) {
            $.post('@Url.Action("GetNama","Claim")',
                {
                    id: nip
                }, function (data) {
                    //console.log(data);
                    var checkstr = confirm(`Are you sure you want to process this ${idklaim}?`);
                    if (checkstr == true) {
                        if (data == 'true') {
                        $.get('@Url.Action("updateClaim", "Claim")',
                            { 'idClaim': idklaim, 'status': "Finished" });
                        $.get('@Url.Action("updatePlafond", "Claim")',
                            { 'idClaim': idklaim },
                            function (data) {
                                alert(data);
                                getData(temp);
                            });
                        }

                    } else {
                        return false;
                    }
                }
            );

        }

        function DeleteClaim(idklaim) {
            console.log(idklaim);
            var checkstr = confirm(`Are you sure you want to delete ${idklaim}?`);
            if (checkstr == true)
            {
                $.get(`/DeleteClaim/${idklaim}`, function (data) {
                    alert(`Delete ${idklaim} Successfully`);
                    getData(temp);
                });
            } else
            {
                return false;
            }
        }

        $("#submit_reject").on("click", function (e) {
            e.preventDefault();
            let formdata = $("#reject").serialize();
            $.ajax({
                    url: '@Url.Action("alasanReject","Claim")',
                    type: 'POST',
                    data: formdata,
                    success: function (data) {
                    $.get('@Url.Action("updateClaim", "Claim")',
                        { 'idClaim': $("#idmedis").val(), 'status': "Rejected" },
                    function () {
                        alert("Claim Request Rejected");
                        getData(temp);
                    });
                    },
                    error: function () {
                        alert("Update Kuota Failed");
                    }
                });
        });

        function RejectClaim(idklaim) {
            //console.log(idklaim);
            var checkstr = confirm(`Are you sure you want to Reject ${idklaim}?`);
            if (checkstr == true) {
                $("#modalReject").modal('show');
                document.getElementById("idmedis").value = idklaim;
            } else {
                return false;
            }
        }
    </script>
}